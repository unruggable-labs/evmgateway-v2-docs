# Concepts

The codebase has been built in an intentionally abstracted manner to allow for flexibility in integrating with new chains.

At a high level:

- A contract defines an `EVMRequest` which when built is passed to the `fetch` method defined in `EVMFetchTarget.sol`. 
- Internally this method implements the ERC-3668 specification and reverts with an `OffchainLookup` telling the client to query our `Gateway`. 
- The response is handled in the 3668 callback `fetchCallback` which passes the response to a chain specific `Verifier` (specified when calling `fetch`) to validate the returned proofs and return the appropriate values to the caller.  

A more in depth overview of these core architectural components is found below:

## Request Builder

`EVMFetcher.sol` defines the public facing API for building an `EVMRequest`.
An `EVMRequest` is made up of a series of operations (`ops`) that are interpreted by the virtual machine to read and manipulate data stored on other blockchains. 

A Solidity developer can write a smart contract that builds a request by having their contract inherit from `EVMFetchTarget.sol`. 

We also offer a Typescript implemetation of the request builder and virtual machine to allow for easy development and testing of requests. Take a look at our [Examples](/examples) page for some.. examples.


- Further details of the methods made available through the Solidity/TS APIs can be found at the [OP Code Reference](/op-code-reference).
- Further information about the implemetation of the Virtual Machine can be found [here](/virtual-machine).

## The Gateway

The `gateway.ts` Typescript file is utilised to provision a simple HTTP gateway server for responding to requests for data from other chains. The constructor takes a `Rollup` as a parameter (see below).


## The Rollup

The chain specific rollup Typescript classes utilise `Prover` and `Commit` generics to provide information to the `Gateway` about how to request data from the chain and generate verifiable proofs.

They implement methods (`encodeWitness`/`encodeWitnessV1`) that define how commit and proof data is encoded for return from the gateway to the client such that it can be appropriately interpreted and verified in the verifier deployed on L1.

### Commits

Commits are an abstract representation of the data submitted to L1 by the relevant L2 chain. Commit data is neccesary for verifying a proof or deriving the appropriate data against which to verify a proof.

The `rollup.ts` base class defines the following `abstract` commit related methods:

 - `fetchLatestCommitIndex` - tells the gateway how to fetch the latest chain specific commit index is
 - `fetchParentCommitIndex` - tells the gateway how to discern the parent index of a commit
 - `fetchCommit` - tells the gateway how to fetch the required commit data

The commit data is encoded in the response from the `Gateway` alongside the proofs.

## Verifiers

The Verifier is a Solidity contract deployed to L1 that is called by the [ERC 3668](https://eips.ethereum.org/EIPS/eip-3668) (CCIP Read: Secure offchain data retrieval) callback when a response is received from the gateway server. The verifier returns proven values to the client having verified the proofs contained within the gateway response. 

Different verifiers implement different Trie structures and as such this verification varies on a chain by chain basis subject to case by case validation and derivation steps. Examples of these differences can be seen in the `EthTrieHooks.sol`, and `LineaTrieHooks.sol` libraries.


### Gateway URL

The Verifier implements the `gatewayURLs()` method that specifies the URL(s) of the `Gateway` which the client should query to service the request.

### Context

Each verifier implements the `getLatestContext` method of the `IEVMVerifier` interface. This method is called and the returned context is passed as part of the `extraData` argument of the `OffchainLookup` revert body. This context is the medium through which a request can specify **its visibility on L2 chain state**. The gateway responds giving consideration to this, and passes the context back as part of its response body.

