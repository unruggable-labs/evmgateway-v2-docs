# Optimism 

We offer support for two types of rollup based on the [Optimism](https://www.optimism.io/) stack, namely rollups that **do** implement the OP Stack [fault proof system](https://docs.optimism.io/stack/protocol/fault-proofs/explainer) (e.g. Optimism Mainnet) and those that **do not** (e.g. [Base](https://www.base.org/)).

## High level overview

Both types of chain utilise the same trie structures. Optimism is EVM compatible and implements its account and storage tries using your standard Patricia Merkle Trie. We verify the returned proofs using the `SecureMerkleTrie.sol` library. What differs is the contracts through which the latest valid L2 state root is discerned on Layer 1 Ethereum.

The Typescript Prover implementation used by OP stack chains is `EthProver.ts`. 


### Context

For chains that **do not** implement fault proofs the  context of the request is the `latestOutputIndex` queried from the `L2OutputOracle` contract.

For chains that **do** implement fault proofs the context of the request is the game index associated with the latest appropriately resolved `FaultDisputeGame`.

### Commit 

The commit data for chains that **do not** implement fault proofs is discerned by calling `getL2Output` on the `L2OutputOracle`. State roots can only be proposed to the `L2OutputOracle` by an access controlled `proposer`.

For chains that **do** implement fault proofs fetching commit data is somewhat more complex.

`OptimismPortalProxy` directs to the `DisputeGameFactory` through which new `FaultDisputeGame` instances are created. The creation of a `FaultDisputeGame` is the mechanism through which a proposal for the current state root of the chain is made. 

Anyone can make a state root proposal and the back and forth process through which games are disputed is what prevents an invalid (for [example](https://etherscan.io/tx/0xafbda91446e4cbf3ca4dc0f8c64920be90625c7d0eedc5f4d65b05acaa5a2d58#eventlog)) L2 state being finalized on L1`.

A game index is used as the commit identifier for these kinds of chain. The appropiate index is discerned by querying the latest `rootClaim` from the `AnchorRegistry` and efficiently finding the game that submitted the claim.

### Response

The `OutputRootProof` is [defined by Optimism](https://github.com/ethereum-optimism/optimism/blob/5a5dd8f44161e8e05093d92b32e102eb38fe78b6/packages/contracts-bedrock/src/libraries/Types.sol#L25-L30) as:

```
    struct OutputRootProof {
        bytes32 version;
        bytes32 stateRoot;
        bytes32 messagePasserStorageRoot;
        bytes32 latestBlockhash;
    }
```

The gateway returns this data alongside individual account/storage proofs for the requested data. We discern that the `OutputRootProof` for the game index that the gateway claims it is returning matches data stored on L1 and then we verify the proofs returned against the associated state root.